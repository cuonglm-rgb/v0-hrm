{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///E:/Pamo/v0-hrm/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\r\n    cookies: {\r\n      getAll() {\r\n        return cookieStore.getAll()\r\n      },\r\n      setAll(cookiesToSet) {\r\n        try {\r\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\r\n        } catch {\r\n          // The \"setAll\" method was called from a Server Component.\r\n          // This can be ignored if you have proxy refreshing user sessions.\r\n        }\r\n      },\r\n    },\r\n  })\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0QAAO;IAEjC,OAAO,IAAA,4SAAkB,oKAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,kEAAkE;gBACpE;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///E:/Pamo/v0-hrm/lib/actions/employee-actions.ts"],"sourcesContent":["\"use server\"\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport type { Employee, EmployeeWithRelations, UserRoleWithRelations } from \"@/lib/types/database\"\r\n\r\nexport async function getMyEmployee(): Promise<EmployeeWithRelations | null> {\r\n  const supabase = await createClient()\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n  if (!user) return null\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"employees\")\r\n    .select(`\r\n      *,\r\n      department:departments(*),\r\n      position:positions(*),\r\n      manager:employees!manager_id(id, full_name, email)\r\n    `)\r\n    .eq(\"user_id\", user.id)\r\n    .single()\r\n\r\n  if (error) {\r\n    console.error(\"Error fetching employee:\", error)\r\n    return null\r\n  }\r\n\r\n  return data as EmployeeWithRelations\r\n}\r\n\r\nexport async function getMyRoles(): Promise<UserRoleWithRelations[]> {\r\n  const supabase = await createClient()\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n  if (!user) return []\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"user_roles\")\r\n    .select(`\r\n      *,\r\n      role:roles(*)\r\n    `)\r\n    .eq(\"user_id\", user.id)\r\n\r\n  if (error) {\r\n    console.error(\"Error fetching roles:\", error)\r\n    return []\r\n  }\r\n\r\n  return (data || []) as UserRoleWithRelations[]\r\n}\r\n\r\nexport async function listEmployees(): Promise<EmployeeWithRelations[]> {\r\n  const supabase = await createClient()\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"employees\")\r\n    .select(`\r\n      *,\r\n      department:departments(*),\r\n      position:positions(*)\r\n    `)\r\n    .order(\"created_at\", { ascending: false })\r\n\r\n  if (error) {\r\n    console.error(\"Error listing employees:\", error)\r\n    return []\r\n  }\r\n\r\n  return (data || []) as EmployeeWithRelations[]\r\n}\r\n\r\nexport async function getEmployee(id: string): Promise<EmployeeWithRelations | null> {\r\n  const supabase = await createClient()\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"employees\")\r\n    .select(`\r\n      *,\r\n      department:departments(*),\r\n      position:positions(*),\r\n      manager:employees!manager_id(id, full_name, email)\r\n    `)\r\n    .eq(\"id\", id)\r\n    .single()\r\n\r\n  if (error) {\r\n    console.error(\"Error fetching employee:\", error)\r\n    return null\r\n  }\r\n\r\n  return data as EmployeeWithRelations\r\n}\r\n\r\nexport async function updateEmployee(\r\n  id: string,\r\n  data: Partial<Pick<Employee, \"full_name\" | \"phone\" | \"department_id\" | \"position_id\" | \"status\" | \"join_date\">>,\r\n) {\r\n  const supabase = await createClient()\r\n\r\n  const { error } = await supabase\r\n    .from(\"employees\")\r\n    .update({ ...data, updated_at: new Date().toISOString() })\r\n    .eq(\"id\", id)\r\n\r\n  if (error) {\r\n    console.error(\"Error updating employee:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/employees\")\r\n  revalidatePath(`/dashboard/employees/${id}`)\r\n  return { success: true }\r\n}\r\n\r\nexport async function updateMyProfile(data: Partial<Pick<Employee, \"full_name\" | \"phone\">>) {\r\n  const supabase = await createClient()\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n  if (!user) return { success: false, error: \"Not authenticated\" }\r\n\r\n  const { error } = await supabase\r\n    .from(\"employees\")\r\n    .update({ ...data, updated_at: new Date().toISOString() })\r\n    .eq(\"user_id\", user.id)\r\n\r\n  if (error) {\r\n    console.error(\"Error updating profile:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/profile\")\r\n  return { success: true }\r\n}\r\n\r\nexport async function createEmployee(data: {\r\n  full_name: string\r\n  email: string\r\n  phone?: string | null\r\n  department_id?: string | null\r\n  position_id?: string | null\r\n  join_date?: string | null\r\n}) {\r\n  const supabase = await createClient()\r\n\r\n  // Generate employee code\r\n  const code = `NV${new Date().toISOString().slice(0, 7).replace(\"-\", \"\")}${Math.floor(Math.random() * 10000)\r\n    .toString()\r\n    .padStart(4, \"0\")}`\r\n\r\n  const { error } = await supabase.from(\"employees\").insert({\r\n    employee_code: code,\r\n    full_name: data.full_name,\r\n    email: data.email,\r\n    phone: data.phone,\r\n    department_id: data.department_id,\r\n    position_id: data.position_id,\r\n    join_date: data.join_date,\r\n    status: \"onboarding\",\r\n  })\r\n\r\n  if (error) {\r\n    console.error(\"Error creating employee:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/employees\")\r\n  return { success: true }\r\n}\r\n\r\n// Đổi phòng ban + lưu lịch sử\r\nexport async function changeDepartment(\r\n  employeeId: string,\r\n  newDepartmentId: string,\r\n  salary?: number\r\n) {\r\n  const supabase = await createClient()\r\n\r\n  // Lấy thông tin hiện tại\r\n  const { data: employee } = await supabase\r\n    .from(\"employees\")\r\n    .select(\"department_id, position_id\")\r\n    .eq(\"id\", employeeId)\r\n    .single()\r\n\r\n  if (!employee) return { success: false, error: \"Employee not found\" }\r\n\r\n  const today = new Date().toISOString().split(\"T\")[0]\r\n\r\n  // Đóng record lịch sử cũ\r\n  await supabase\r\n    .from(\"employee_job_history\")\r\n    .update({ end_date: today })\r\n    .eq(\"employee_id\", employeeId)\r\n    .is(\"end_date\", null)\r\n\r\n  // Tạo record lịch sử mới\r\n  await supabase.from(\"employee_job_history\").insert({\r\n    employee_id: employeeId,\r\n    department_id: newDepartmentId,\r\n    position_id: employee.position_id,\r\n    salary: salary || null,\r\n    start_date: today,\r\n  })\r\n\r\n  // Update employee\r\n  const { error } = await supabase\r\n    .from(\"employees\")\r\n    .update({ department_id: newDepartmentId, updated_at: new Date().toISOString() })\r\n    .eq(\"id\", employeeId)\r\n\r\n  if (error) {\r\n    console.error(\"Error changing department:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/employees\")\r\n  revalidatePath(`/dashboard/employees/${employeeId}`)\r\n  return { success: true }\r\n}\r\n\r\n// Đổi chức vụ + lưu lịch sử\r\nexport async function changePosition(\r\n  employeeId: string,\r\n  newPositionId: string,\r\n  salary?: number\r\n) {\r\n  const supabase = await createClient()\r\n\r\n  // Lấy thông tin hiện tại\r\n  const { data: employee } = await supabase\r\n    .from(\"employees\")\r\n    .select(\"department_id, position_id\")\r\n    .eq(\"id\", employeeId)\r\n    .single()\r\n\r\n  if (!employee) return { success: false, error: \"Employee not found\" }\r\n\r\n  const today = new Date().toISOString().split(\"T\")[0]\r\n\r\n  // Đóng record lịch sử cũ\r\n  await supabase\r\n    .from(\"employee_job_history\")\r\n    .update({ end_date: today })\r\n    .eq(\"employee_id\", employeeId)\r\n    .is(\"end_date\", null)\r\n\r\n  // Tạo record lịch sử mới\r\n  await supabase.from(\"employee_job_history\").insert({\r\n    employee_id: employeeId,\r\n    department_id: employee.department_id,\r\n    position_id: newPositionId,\r\n    salary: salary || null,\r\n    start_date: today,\r\n  })\r\n\r\n  // Update employee\r\n  const { error } = await supabase\r\n    .from(\"employees\")\r\n    .update({ position_id: newPositionId, updated_at: new Date().toISOString() })\r\n    .eq(\"id\", employeeId)\r\n\r\n  if (error) {\r\n    console.error(\"Error changing position:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/employees\")\r\n  revalidatePath(`/dashboard/employees/${employeeId}`)\r\n  return { success: true }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 292, "column": 0}, "map": {"version":3,"sources":["file:///E:/Pamo/v0-hrm/lib/actions/allowance-actions.ts"],"sourcesContent":["\"use server\"\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport type {\r\n  AllowanceType,\r\n  AllowanceDeductionRules,\r\n  EmployeeAllowanceWithType,\r\n} from \"@/lib/types/database\"\r\n\r\n// =============================================\r\n// ALLOWANCE TYPE ACTIONS\r\n// =============================================\r\n\r\nexport async function listAllowanceTypes(): Promise<AllowanceType[]> {\r\n  const supabase = await createClient()\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"allowance_types\")\r\n    .select(\"*\")\r\n    .order(\"name\")\r\n\r\n  if (error) {\r\n    // Bảng chưa tồn tại - cần chạy script 016-allowance-types.sql\r\n    if (error.code === \"42P01\" || error.message?.includes(\"does not exist\")) {\r\n      console.warn(\"Bảng allowance_types chưa tồn tại. Vui lòng chạy script 016-allowance-types.sql\")\r\n    } else {\r\n      console.error(\"Error listing allowance types:\", error.message || error)\r\n    }\r\n    return []\r\n  }\r\n\r\n  return data || []\r\n}\r\n\r\nexport async function createAllowanceType(input: {\r\n  name: string\r\n  code?: string\r\n  amount: number\r\n  calculation_type: \"fixed\" | \"daily\"\r\n  is_deductible: boolean\r\n  deduction_rules?: AllowanceDeductionRules\r\n  description?: string\r\n}) {\r\n  const supabase = await createClient()\r\n\r\n  const { error } = await supabase.from(\"allowance_types\").insert({\r\n    name: input.name,\r\n    code: input.code || null,\r\n    amount: input.amount,\r\n    calculation_type: input.calculation_type,\r\n    is_deductible: input.is_deductible,\r\n    deduction_rules: input.deduction_rules || null,\r\n    description: input.description || null,\r\n    is_active: true,\r\n  })\r\n\r\n  if (error) {\r\n    console.error(\"Error creating allowance type:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/allowances\")\r\n  return { success: true }\r\n}\r\n\r\nexport async function updateAllowanceType(\r\n  id: string,\r\n  input: {\r\n    name?: string\r\n    code?: string\r\n    amount?: number\r\n    calculation_type?: \"fixed\" | \"daily\"\r\n    is_deductible?: boolean\r\n    deduction_rules?: AllowanceDeductionRules | null\r\n    description?: string\r\n    is_active?: boolean\r\n  }\r\n) {\r\n  const supabase = await createClient()\r\n\r\n  const { error } = await supabase\r\n    .from(\"allowance_types\")\r\n    .update(input)\r\n    .eq(\"id\", id)\r\n\r\n  if (error) {\r\n    console.error(\"Error updating allowance type:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/allowances\")\r\n  return { success: true }\r\n}\r\n\r\nexport async function deleteAllowanceType(id: string) {\r\n  const supabase = await createClient()\r\n\r\n  // Kiểm tra có nhân viên đang dùng không\r\n  const { count } = await supabase\r\n    .from(\"employee_allowances\")\r\n    .select(\"*\", { count: \"exact\", head: true })\r\n    .eq(\"allowance_type_id\", id)\r\n\r\n  if (count && count > 0) {\r\n    return { success: false, error: \"Không thể xóa phụ cấp đang được gán cho nhân viên\" }\r\n  }\r\n\r\n  const { error } = await supabase.from(\"allowance_types\").delete().eq(\"id\", id)\r\n\r\n  if (error) {\r\n    console.error(\"Error deleting allowance type:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/allowances\")\r\n  return { success: true }\r\n}\r\n\r\n// =============================================\r\n// EMPLOYEE ALLOWANCE ACTIONS\r\n// =============================================\r\n\r\nexport async function listEmployeeAllowances(\r\n  employee_id: string\r\n): Promise<EmployeeAllowanceWithType[]> {\r\n  const supabase = await createClient()\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"employee_allowances\")\r\n    .select(`\r\n      *,\r\n      allowance_type:allowance_types(*)\r\n    `)\r\n    .eq(\"employee_id\", employee_id)\r\n    .order(\"effective_date\", { ascending: false })\r\n\r\n  if (error) {\r\n    console.error(\"Error listing employee allowances:\", error)\r\n    return []\r\n  }\r\n\r\n  return (data || []) as EmployeeAllowanceWithType[]\r\n}\r\n\r\nexport async function assignAllowanceToEmployee(input: {\r\n  employee_id: string\r\n  allowance_type_id: string\r\n  custom_amount?: number\r\n  effective_date: string\r\n  end_date?: string\r\n  note?: string\r\n}) {\r\n  const supabase = await createClient()\r\n\r\n  const { error } = await supabase.from(\"employee_allowances\").insert({\r\n    employee_id: input.employee_id,\r\n    allowance_type_id: input.allowance_type_id,\r\n    custom_amount: input.custom_amount || null,\r\n    effective_date: input.effective_date,\r\n    end_date: input.end_date || null,\r\n    note: input.note || null,\r\n  })\r\n\r\n  if (error) {\r\n    console.error(\"Error assigning allowance:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/employees\")\r\n  return { success: true }\r\n}\r\n\r\nexport async function updateEmployeeAllowance(\r\n  id: string,\r\n  input: {\r\n    custom_amount?: number | null\r\n    end_date?: string | null\r\n    note?: string\r\n  }\r\n) {\r\n  const supabase = await createClient()\r\n\r\n  const { error } = await supabase\r\n    .from(\"employee_allowances\")\r\n    .update(input)\r\n    .eq(\"id\", id)\r\n\r\n  if (error) {\r\n    console.error(\"Error updating employee allowance:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/employees\")\r\n  return { success: true }\r\n}\r\n\r\nexport async function removeEmployeeAllowance(id: string) {\r\n  const supabase = await createClient()\r\n\r\n  const { error } = await supabase.from(\"employee_allowances\").delete().eq(\"id\", id)\r\n\r\n  if (error) {\r\n    console.error(\"Error removing employee allowance:\", error)\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/employees\")\r\n  return { success: true }\r\n}\r\n\r\n// =============================================\r\n// HELPER: Tính phụ cấp cho payroll\r\n// =============================================\r\n\r\nexport async function calculateEmployeeAllowances(\r\n  employee_id: string,\r\n  month: number,\r\n  year: number,\r\n  workingDays: number,\r\n  lateCount: number,\r\n  absentDays: number\r\n) {\r\n  const supabase = await createClient()\r\n\r\n  const endDate = new Date(year, month, 0).toISOString().split(\"T\")[0]\r\n  const startDate = `${year}-${String(month).padStart(2, \"0\")}-01`\r\n\r\n  // Lấy các phụ cấp đang hiệu lực của nhân viên\r\n  const { data: employeeAllowances } = await supabase\r\n    .from(\"employee_allowances\")\r\n    .select(`\r\n      *,\r\n      allowance_type:allowance_types(*)\r\n    `)\r\n    .eq(\"employee_id\", employee_id)\r\n    .lte(\"effective_date\", endDate)\r\n    .or(`end_date.is.null,end_date.gte.${startDate}`)\r\n\r\n  if (!employeeAllowances || employeeAllowances.length === 0) {\r\n    return { totalAllowance: 0, details: [] }\r\n  }\r\n\r\n  const details: {\r\n    allowance_type_id: string\r\n    base_amount: number\r\n    deducted_amount: number\r\n    final_amount: number\r\n    deduction_reason: string | null\r\n    late_count: number\r\n    absent_days: number\r\n  }[] = []\r\n\r\n  let totalAllowance = 0\r\n\r\n  for (const ea of employeeAllowances) {\r\n    const allowanceType = ea.allowance_type as AllowanceType\r\n    if (!allowanceType || !allowanceType.is_active) continue\r\n\r\n    const amount = ea.custom_amount || allowanceType.amount\r\n    let baseAmount = amount\r\n    let deductedAmount = 0\r\n    let deductionReason: string | null = null\r\n\r\n    // Tính base amount theo loại\r\n    if (allowanceType.calculation_type === \"daily\") {\r\n      baseAmount = amount * workingDays\r\n    }\r\n\r\n    // Áp dụng quy tắc trừ phụ cấp\r\n    if (allowanceType.is_deductible && allowanceType.deduction_rules) {\r\n      const rules = allowanceType.deduction_rules as AllowanceDeductionRules\r\n      const reasons: string[] = []\r\n\r\n      // Trừ khi nghỉ làm\r\n      if (rules.deduct_on_absent && absentDays > 0) {\r\n        if (allowanceType.calculation_type === \"daily\") {\r\n          // Đã tính theo ngày công rồi, không cần trừ thêm\r\n        } else {\r\n          // Fixed: trừ theo tỷ lệ\r\n          const deductPerDay = amount / 26 // 26 ngày công chuẩn\r\n          deductedAmount += deductPerDay * absentDays\r\n          reasons.push(`Nghỉ ${absentDays} ngày`)\r\n        }\r\n      }\r\n\r\n      // Trừ khi đi muộn\r\n      if (rules.deduct_on_late && lateCount > 0) {\r\n        const graceCount = rules.late_grace_count || 0\r\n        const excessLate = Math.max(0, lateCount - graceCount)\r\n\r\n        if (excessLate > 0) {\r\n          // Kiểm tra full_deduct_threshold\r\n          if (rules.full_deduct_threshold && lateCount >= rules.full_deduct_threshold) {\r\n            deductedAmount = baseAmount // Mất toàn bộ\r\n            reasons.push(`Đi muộn ${lateCount} lần (mất toàn bộ)`)\r\n          } else if (allowanceType.calculation_type === \"daily\") {\r\n            // Trừ theo số ngày đi muộn vượt quá\r\n            deductedAmount += amount * excessLate\r\n            reasons.push(`Đi muộn ${excessLate} lần (vượt ${graceCount} lần miễn)`)\r\n          } else {\r\n            // Fixed: trừ theo tỷ lệ\r\n            const deductPerLate = amount / 26\r\n            deductedAmount += deductPerLate * excessLate\r\n            reasons.push(`Đi muộn ${excessLate} lần`)\r\n          }\r\n        }\r\n      }\r\n\r\n      if (reasons.length > 0) {\r\n        deductionReason = reasons.join(\", \")\r\n      }\r\n    }\r\n\r\n    // Đảm bảo không trừ quá base\r\n    deductedAmount = Math.min(deductedAmount, baseAmount)\r\n    const finalAmount = baseAmount - deductedAmount\r\n\r\n    details.push({\r\n      allowance_type_id: allowanceType.id,\r\n      base_amount: baseAmount,\r\n      deducted_amount: deductedAmount,\r\n      final_amount: finalAmount,\r\n      deduction_reason: deductionReason,\r\n      late_count: lateCount,\r\n      absent_days: absentDays,\r\n    })\r\n\r\n    totalAllowance += finalAmount\r\n  }\r\n\r\n  return { totalAllowance, details }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 577, "column": 0}, "map": {"version":3,"sources":["file:///E:/Pamo/v0-hrm/.next-internal/server/app/dashboard/allowances/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getMyRoles as '005e20e2e268d812762b030e4aac3b7693066871b6'} from 'ACTIONS_MODULE0'\nexport {getMyEmployee as '00636a7c2e61bd285b975ea815e7fbbefdffae959f'} from 'ACTIONS_MODULE0'\nexport {listEmployees as '00b0c7f0352396833a3aa70b738bb3a8c2a485efae'} from 'ACTIONS_MODULE0'\nexport {createEmployee as '4072cdebcca1df607d08f62096843ddf91d2cf29f6'} from 'ACTIONS_MODULE0'\nexport {updateMyProfile as '407a7f2085358134fb9b61998dbd9fa880ad52c2cf'} from 'ACTIONS_MODULE0'\nexport {getEmployee as '409df3c5b25ea33596f872aab0b186da47271a8e80'} from 'ACTIONS_MODULE0'\nexport {updateEmployee as '60e7529b55507157f11112b5c625757ac226a23a7c'} from 'ACTIONS_MODULE0'\nexport {changeDepartment as '701419c868154523741dd2880ac65e97064ceb8620'} from 'ACTIONS_MODULE0'\nexport {changePosition as '70daddb01ea9f495d095baa024616ddfa6ee94f8dd'} from 'ACTIONS_MODULE0'\nexport {listAllowanceTypes as '00e07ac3c20a776facdd854cf9091bd2b969eadba5'} from 'ACTIONS_MODULE1'\nexport {deleteAllowanceType as '4046aaa30e394173b6bdd851189594604df72dadfd'} from 'ACTIONS_MODULE1'\nexport {listEmployeeAllowances as '4063f89fdf119fef6c15ef5f8cfceecf1f2879e287'} from 'ACTIONS_MODULE1'\nexport {assignAllowanceToEmployee as '406b7022e253978d9328109c1b16a7e953a8f7610f'} from 'ACTIONS_MODULE1'\nexport {removeEmployeeAllowance as '40dc7a1d74196365975750875be59a833b89c2c703'} from 'ACTIONS_MODULE1'\nexport {createAllowanceType as '40e3b60da12a8aa54c6e928db8e2afc9094a442b0b'} from 'ACTIONS_MODULE1'\nexport {updateEmployeeAllowance as '601e21d88517fe7e03338021d716ae56821d0930b7'} from 'ACTIONS_MODULE1'\nexport {updateAllowanceType as '609a52031a6106b0e8b0ba9417d2fa8f73cedd6993'} from 'ACTIONS_MODULE1'\nexport {calculateEmployeeAllowances as '7ee195ab1271622b7a211c8ccdb2dc773381e167a2'} from 'ACTIONS_MODULE1'\nexport {createAllowanceType as '40e3b60da12a8aa54c6e928db8e2afc9094a442b0b'} from 'ACTIONS_MODULE1'\nexport {updateAllowanceType as '609a52031a6106b0e8b0ba9417d2fa8f73cedd6993'} from 'ACTIONS_MODULE1'\nexport {deleteAllowanceType as '4046aaa30e394173b6bdd851189594604df72dadfd'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AASA"}}]
}