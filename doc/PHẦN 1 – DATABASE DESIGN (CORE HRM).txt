PHáº¦N 1 â€“ DATABASE DESIGN (CORE HRM)
1. NguyÃªn táº¯c thiáº¿t káº¿ (ráº¥t quan trá»ng)

âœ… DÃ¹ng UUID
âœ… KhÃ´ng xÃ³a cá»©ng dá»¯ liá»‡u nhÃ¢n sá»±
âœ… LÆ°u lá»‹ch sá»­ thay Ä‘á»•i (job, lÆ°Æ¡ng)
âœ… PhÃ¢n quyá»n báº±ng RLS, khÃ´ng check quyá»n á»Ÿ frontend
âœ… TÃ¡ch báº£ng â€œlog / historyâ€

2. SÆ¡ Ä‘á»“ báº£ng chÃ­nh (Core Tables)
auth.users
   â”‚
   â””â”€â”€ employees
         â”œâ”€â”€ employee_job_history
         â”œâ”€â”€ salary_structure
         â”œâ”€â”€ attendance_logs
         â”œâ”€â”€ leave_requests
         â””â”€â”€ payroll_items

PHáº¦N 2 â€“ SQL SCHEMA (CORE HR)
2.1 departments
create table departments (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  parent_id uuid references departments(id),
  created_at timestamptz default now()
);

2.2 positions
create table positions (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  level int,
  created_at timestamptz default now()
);

2.3 employees (Báº¢NG QUAN TRá»ŒNG NHáº¤T)
create table employees (
  id uuid primary key default gen_random_uuid(),
  user_id uuid unique references auth.users(id),
  employee_code text unique not null,
  full_name text not null,
  email text,
  phone text,
  dob date,

  department_id uuid references departments(id),
  position_id uuid references positions(id),
  manager_id uuid references employees(id),

  join_date date,
  status text check (status in ('onboarding','active','resigned')),

  created_at timestamptz default now()
);


ğŸ“Œ KHÃ”NG DELETE nhÃ¢n viÃªn â€“ chá»‰ update status

2.4 employee_job_history (lá»‹ch sá»­ chá»©c danh & lÆ°Æ¡ng)
create table employee_job_history (
  id uuid primary key default gen_random_uuid(),
  employee_id uuid references employees(id),
  department_id uuid references departments(id),
  position_id uuid references positions(id),
  salary numeric,
  start_date date not null,
  end_date date,
  created_at timestamptz default now()
);

PHáº¦N 3 â€“ ATTENDANCE & LEAVE (rÃºt gá»n)
3.1 attendance_logs
create table attendance_logs (
  id uuid primary key default gen_random_uuid(),
  employee_id uuid references employees(id),
  check_in timestamptz,
  check_out timestamptz,
  source text,
  created_at timestamptz default now()
);

3.2 leave_requests
create table leave_requests (
  id uuid primary key default gen_random_uuid(),
  employee_id uuid references employees(id),
  leave_type text,
  from_date date,
  to_date date,
  status text check (status in ('pending','approved','rejected')),
  approver_id uuid references employees(id),
  created_at timestamptz default now()
);

PHáº¦N 4 â€“ PAYROLL (core, chÆ°a full)
4.1 payroll_runs
create table payroll_runs (
  id uuid primary key default gen_random_uuid(),
  month int,
  year int,
  status text check (status in ('draft','locked','paid')),
  created_at timestamptz default now()
);

4.2 payroll_items
create table payroll_items (
  id uuid primary key default gen_random_uuid(),
  payroll_run_id uuid references payroll_runs(id),
  employee_id uuid references employees(id),
  total_income numeric,
  total_deduction numeric,
  net_salary numeric
);

PHáº¦N 5 â€“ ROLE MODEL (RBAC)
5.1 roles
create table roles (
  id uuid primary key default gen_random_uuid(),
  code text unique,
  name text
);

Dá»¯ liá»‡u máº«u:
admin | hr | manager | employee

5.2 user_roles
create table user_roles (
  user_id uuid references auth.users(id),
  role_id uuid references roles(id),
  department_id uuid references departments(id),
  primary key (user_id, role_id)
);

PHáº¦N 6 â€“ RLS POLICY (TRÃI TIM Cá»¦A SUPABASE)
6.1 Báº­t RLS
alter table employees enable row level security;

6.2 Employee chá»‰ xem chÃ­nh mÃ¬nh
create policy employee_view_self
on employees
for select
using (
  user_id = auth.uid()
);

6.3 HR xem toÃ n bá»™ nhÃ¢n sá»±
create policy hr_view_all
on employees
for select
using (
  exists (
    select 1 from user_roles ur
    join roles r on ur.role_id = r.id
    where ur.user_id = auth.uid()
      and r.code = 'hr'
  )
);

6.4 Manager xem nhÃ¢n viÃªn phÃ²ng mÃ¬nh
create policy manager_view_department
on employees
for select
using (
  department_id in (
    select department_id
    from employees
    where user_id = auth.uid()
  )
);

6.5 Employee táº¡o leave request cho mÃ¬nh
alter table leave_requests enable row level security;

create policy employee_create_leave
on leave_requests
for insert
with check (
  employee_id in (
    select id from employees where user_id = auth.uid()
  )
);

PHáº¦N 7 â€“ INDEX (Báº®T BUá»˜C CHO PERFORMANCE)
create index idx_employee_department on employees(department_id);
create index idx_attendance_employee on attendance_logs(employee_id);
create index idx_leave_employee on leave_requests(employee_id);
