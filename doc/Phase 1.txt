M√¨nh s·∫Ω l√†m PHASE 1 ‚Äì EMPLOYEE CRUD (FULL BACKEND + FRONTEND) theo ƒë√∫ng chu·∫©n Supabase + Next.js App Router, ki·ªÉu copy l√†m ƒë∆∞·ª£c ngay, kh√¥ng l√Ω thuy·∫øt th·ª´a.

üéØ K·∫øt qu·∫£ Phase 1
HR c√≥ th·ªÉ:

Xem danh s√°ch nh√¢n s·ª±

T·∫°o / s·ª≠a nh√¢n s·ª±

Xem chi ti·∫øt + l·ªãch s·ª≠ c√¥ng vi·ªác

Employee:

Ch·ªâ xem h·ªì s∆° c·ªßa m√¨nh

PHASE 1 ‚Äì EMPLOYEE CRUD (CORE HR)
1Ô∏è‚É£ BACKEND ‚Äì DATABASE (nh·∫Øc nhanh)

B·∫°n ƒë√£ c√≥:

employees

departments

positions

employee_job_history

RLS

üëâ Phase n√†y KH√îNG ƒë·ª•ng payroll / attendance

2Ô∏è‚É£ BACKEND ‚Äì SERVER ACTION (QUAN TR·ªåNG)
2.1 C·∫•u tr√∫c th∆∞ m·ª•c
app/
 ‚îú‚îÄ actions/
 ‚îÇ   ‚îî‚îÄ employees.ts
 ‚îú‚îÄ dashboard/
 ‚îÇ   ‚îî‚îÄ hr/
 ‚îÇ       ‚îî‚îÄ employees/

2.2 Supabase server client

lib/supabase-server.ts

import { createServerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'

export function supabaseServer() {
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!, // server only
    { cookies }
  )
}


‚ö†Ô∏è File n√†y ch·ªâ d√πng ·ªü server

2.3 Action: getEmployees (HR list)
// app/actions/employees.ts
'use server'

import { supabaseServer } from '@/lib/supabase-server'

export async function getEmployees() {
  const supabase = supabaseServer()

  const { data, error } = await supabase
    .from('employees')
    .select(`
      id,
      employee_code,
      full_name,
      email,
      status,
      departments(name),
      positions(name)
    `)
    .order('created_at', { ascending: false })

  if (error) throw error
  return data
}


üëâ RLS s·∫Ω t·ª± l·ªçc theo role

2.4 Action: createEmployee (HR)
export async function createEmployee(form: {
  employee_code: string
  full_name: string
  email: string
  department_id: string
  position_id: string
  join_date: string
}) {
  const supabase = supabaseServer()

  const { error } = await supabase.from('employees').insert({
    ...form,
    status: 'onboarding'
  })

  if (error) throw error
}

2.5 Action: updateEmployee
export async function updateEmployee(
  id: string,
  form: Partial<{
    full_name: string
    email: string
    department_id: string
    position_id: string
    status: string
  }>
) {
  const supabase = supabaseServer()

  const { error } = await supabase
    .from('employees')
    .update(form)
    .eq('id', id)

  if (error) throw error
}

2.6 Action: changeJob (ghi l·ªãch s·ª≠)
export async function changeJob(
  employee_id: string,
  department_id: string,
  position_id: string,
  salary?: number
) {
  const supabase = supabaseServer()

  // close old job
  await supabase
    .from('employee_job_history')
    .update({ end_date: new Date().toISOString() })
    .eq('employee_id', employee_id)
    .is('end_date', null)

  // insert new job
  const { error } = await supabase
    .from('employee_job_history')
    .insert({
      employee_id,
      department_id,
      position_id,
      salary,
      start_date: new Date().toISOString()
    })

  if (error) throw error
}

3Ô∏è‚É£ FRONTEND ‚Äì HR UI
3.1 Danh s√°ch nh√¢n s·ª±

/dashboard/hr/employees/page.tsx

import { getEmployees } from '@/app/actions/employees'

export default async function EmployeePage() {
  const employees = await getEmployees()

  return (
    <div>
      <h1>Employees</h1>

      <table>
        <thead>
          <tr>
            <th>M√£</th>
            <th>T√™n</th>
            <th>Ph√≤ng</th>
            <th>V·ªã tr√≠</th>
            <th>Tr·∫°ng th√°i</th>
          </tr>
        </thead>
        <tbody>
          {employees.map((e) => (
            <tr key={e.id}>
              <td>{e.employee_code}</td>
              <td>{e.full_name}</td>
              <td>{e.departments?.name}</td>
              <td>{e.positions?.name}</td>
              <td>{e.status}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )
}

3.2 T·∫°o nh√¢n s·ª±

/dashboard/hr/employees/new/page.tsx

'use client'

import { createEmployee } from '@/app/actions/employees'

export default function NewEmployee() {
  async function onSubmit(formData: FormData) {
    await createEmployee({
      employee_code: formData.get('code') as string,
      full_name: formData.get('name') as string,
      email: formData.get('email') as string,
      department_id: formData.get('department') as string,
      position_id: formData.get('position') as string,
      join_date: formData.get('join_date') as string
    })
  }

  return (
    <form action={onSubmit}>
      <input name="code" placeholder="Employee Code" />
      <input name="name" placeholder="Full name" />
      <input name="email" />
      <button type="submit">Create</button>
    </form>
  )
}

4Ô∏è‚É£ FRONTEND ‚Äì EMPLOYEE VIEW (SELF PROFILE)

/dashboard/employee/profile/page.tsx

import { supabaseServer } from '@/lib/supabase-server'

export default async function MyProfile() {
  const supabase = supabaseServer()

  const { data } = await supabase
    .from('employees')
    .select('*')
    .single()

  return (
    <div>
      <h2>{data.full_name}</h2>
      <p>{data.email}</p>
      <p>Status: {data.status}</p>
    </div>
  )
}


üëâ RLS ƒë·∫£m b·∫£o ch·ªâ ra ƒë√∫ng 1 record c·ªßa user

5Ô∏è‚É£ CHECKLIST PHASE 1 (xong l√† OK)

‚úÖ HR list nh√¢n s·ª±
‚úÖ HR t·∫°o / s·ª≠a nh√¢n s·ª±
‚úÖ L∆∞u l·ªãch s·ª≠ c√¥ng vi·ªác
‚úÖ Employee ch·ªâ xem m√¨nh
‚úÖ Kh√¥ng leak data

6Ô∏è‚É£ L·ªñI TH∆Ø·ªúNG G·∫∂P (NH·ªö TR√ÅNH)

‚ùå CRUD t·ª´ client Supabase tr·ª±c ti·∫øp
‚ùå Kh√¥ng ghi job history khi ƒë·ªïi ph√≤ng
‚ùå Cho manager s·ª≠a l∆∞∆°ng
‚ùå Delete nh√¢n vi√™n