PHASE 3 â€“ PAYROLL (BACKEND + FRONTEND)
Tá»•ng thá»ƒ luá»“ng chuáº©n
Attendance (raw)
   â†“
Work shift + Leave
   â†“
Workday calculation (job)
   â†“
Payroll run (draft)
   â†“
HR review
   â†“
LOCK
   â†“
Payslip

1ï¸âƒ£ BACKEND â€“ DATABASE (PAYROLL CORE)
1.1 salary_structure (lá»‹ch sá»­ lÆ°Æ¡ng)
create table salary_structure (
  id uuid primary key default gen_random_uuid(),
  employee_id uuid references employees(id),
  base_salary numeric not null,
  allowance numeric default 0,
  effective_date date not null,
  created_at timestamptz default now()
);

create index idx_salary_employee_date
on salary_structure(employee_id, effective_date);


ğŸ“Œ Quy táº¯c:

KhÃ´ng update

Má»—i láº§n Ä‘á»•i lÆ°Æ¡ng â†’ insert record má»›i

1.2 payroll_runs
create table payroll_runs (
  id uuid primary key default gen_random_uuid(),
  month int not null,
  year int not null,
  status text check (status in ('draft','locked','paid')),
  created_by uuid references auth.users(id),
  created_at timestamptz default now(),
  unique(month, year)
);

1.3 payroll_items (káº¿t quáº£ cuá»‘i)
create table payroll_items (
  id uuid primary key default gen_random_uuid(),
  payroll_run_id uuid references payroll_runs(id),
  employee_id uuid references employees(id),

  working_days numeric,
  leave_days numeric,
  unpaid_leave_days numeric,

  gross_salary numeric,
  deduction numeric,
  net_salary numeric,

  created_at timestamptz default now(),
  unique(payroll_run_id, employee_id)
);

2ï¸âƒ£ BACKEND â€“ WORKDAY CALCULATION (TRÃI TIM)
2.1 NguyÃªn táº¯c tÃ­nh cÃ´ng (VN chuáº©n)

VÃ­ dá»¥:

CÃ´ng chuáº©n: 26 ngÃ y

LÆ°Æ¡ng thÃ¡ng / 26 = lÆ°Æ¡ng ngÃ y

Nghá»‰ phÃ©p nÄƒm: váº«n hÆ°á»Ÿng lÆ°Æ¡ng

Nghá»‰ khÃ´ng lÆ°Æ¡ng: trá»«

2.2 SQL helper â€“ láº¥y lÆ°Æ¡ng hiá»‡u lá»±c
select *
from salary_structure
where employee_id = $1
  and effective_date <= $2
order by effective_date desc
limit 1;

2.3 Attendance â†’ working days (pseudo)
working_days =
  sá»‘ ngÃ y cÃ³ check_in
  - sá»‘ ngÃ y nghá»‰ khÃ´ng lÆ°Æ¡ng


âš ï¸ KHÃ”NG tÃ­nh theo giá» á»Ÿ phase nÃ y
(OT lÃ m phase sau)

3ï¸âƒ£ BACKEND â€“ SERVER ACTION PAYROLL
3.1 generatePayroll (HR only)
'use server'

import { supabaseServer } from '@/lib/supabase-server'

export async function generatePayroll(month: number, year: number) {
  const supabase = supabaseServer()

  // create payroll run
  const { data: run } = await supabase
    .from('payroll_runs')
    .insert({
      month,
      year,
      status: 'draft'
    })
    .select()
    .single()

  // fetch employees
  const { data: employees } = await supabase
    .from('employees')
    .select('id')
    .eq('status', 'active')

  for (const emp of employees) {
    // fetch salary
    const { data: salary } = await supabase
      .from('salary_structure')
      .select('*')
      .eq('employee_id', emp.id)
      .lte('effective_date', `${year}-${month}-01`)
      .order('effective_date', { ascending: false })
      .limit(1)
      .single()

    if (!salary) continue

    // TODO: tÃ­nh working_days, leave_days
    const working_days = 26
    const leave_days = 0
    const unpaid_leave_days = 0

    const daily_salary = salary.base_salary / 26
    const gross = daily_salary * working_days
    const deduction = daily_salary * unpaid_leave_days

    await supabase.from('payroll_items').insert({
      payroll_run_id: run.id,
      employee_id: emp.id,
      working_days,
      leave_days,
      unpaid_leave_days,
      gross_salary: gross,
      deduction,
      net_salary: gross - deduction
    })
  }
}

3.2 lockPayroll (KHÃ“A â€“ Ráº¤T QUAN TRá»ŒNG)
export async function lockPayroll(run_id: string) {
  const supabase = supabaseServer()

  await supabase
    .from('payroll_runs')
    .update({ status: 'locked' })
    .eq('id', run_id)
}

4ï¸âƒ£ BACKEND â€“ RLS PAYROLL (Cá»°C NHáº Y Cáº¢M)
4.1 payroll_items â€“ enable RLS
alter table payroll_items enable row level security;

Employee chá»‰ xem lÆ°Æ¡ng cá»§a mÃ¬nh
create policy employee_view_own_payroll
on payroll_items
for select
using (
  employee_id in (
    select id from employees where user_id = auth.uid()
  )
);

HR full access
create policy hr_full_payroll
on payroll_items
for all
using (
  exists (
    select 1
    from user_roles ur
    join roles r on ur.role_id = r.id
    where ur.user_id = auth.uid()
      and r.code = 'hr'
  )
);

âŒ Manager KHÃ”NG cÃ³ policy â†’ khÃ´ng tháº¥y gÃ¬
5ï¸âƒ£ FRONTEND â€“ HR PAYROLL
5.1 Payroll list
/dashboard/hr/payroll


Hiá»ƒn thá»‹:

ThÃ¡ng / nÄƒm

Status

Button:

Generate

Lock

5.2 Payroll detail
/dashboard/hr/payroll/[run_id]


Table:

TÃªn NV

CÃ´ng

Gross

Deduction

Net

6ï¸âƒ£ FRONTEND â€“ EMPLOYEE PAYSLIP
/dashboard/employee/payroll


Hiá»ƒn thá»‹:

ThÃ¡ng

Net salary

Chi tiáº¿t:

CÃ´ng

Nghá»‰

Kháº¥u trá»«

ğŸ‘‰ KhÃ´ng cáº§n check role FE
ğŸ‘‰ RLS tá»± báº£o vá»‡

7ï¸âƒ£ CHECKLIST PHASE 3 (Äáº T CHUáº¨N)

âœ… LÆ°Æ¡ng láº¥y theo effective_date
âœ… KhÃ´ng sá»­a payroll sau khi lock
âœ… Employee chá»‰ xem mÃ¬nh
âœ… Manager khÃ´ng xem Ä‘Æ°á»£c
âœ… Payroll tÃ¡i táº¡o Ä‘Æ°á»£c náº¿u xÃ³a draft
