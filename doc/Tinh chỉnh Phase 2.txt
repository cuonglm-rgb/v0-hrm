PHASE 2+ â€“ TINH CHá»ˆNH ATTENDANCE & LEAVE

(Ä‘Ã£ cháº¡y Ä‘Æ°á»£c â†’ lÃ m cho ÄÃšNG â€“ Äáº¸P â€“ KHÃ”NG SAI)

Ná»™i dung tinh chá»‰nh

1ï¸âƒ£ Ca lÃ m (work shift)
2ï¸âƒ£ Validation backend (chá»‘ng cháº¥m cÃ´ng bá»«a)
3ï¸âƒ£ Attendance logic chuáº©n
4ï¸âƒ£ Leave validation (Ä‘Ã¨ ngÃ y, sá»­a sau duyá»‡t)
5ï¸âƒ£ UX thá»±c táº¿ cho HR / Employee / Manager

1ï¸âƒ£ CA LÃ€M (WORK SHIFT) â€“ Báº®T BUá»˜C
1.1 Database: work_shifts
create table work_shifts (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  start_time time not null,
  end_time time not null,
  break_minutes int default 0,
  created_at timestamptz default now()
);


VÃ­ dá»¥:

name	start	end
HC	08:30	17:30
Night	22:00	06:00
1.2 GÃ¡n ca cho nhÃ¢n viÃªn
alter table employees
add column shift_id uuid references work_shifts(id);


ğŸ‘‰ KHÃ”NG gÃ¡n ca trong attendance
ğŸ‘‰ Attendance chá»‰ ghi thá»±c táº¿

2ï¸âƒ£ ATTENDANCE â€“ VALIDATION BACKEND
2.1 Chá»‘ng check-in nhiá»u láº§n/ngÃ y
export async function checkIn() {
  const supabase = supabaseServer()

  const { data: emp } = await supabase
    .from('employees')
    .select('id')
    .single()

  const today = new Date().toISOString().slice(0, 10)

  const { data: existed } = await supabase
    .from('attendance_logs')
    .select('id')
    .eq('employee_id', emp.id)
    .gte('check_in', `${today}T00:00:00`)
    .single()

  if (existed) throw new Error('Already checked in today')

  await supabase.from('attendance_logs').insert({
    employee_id: emp.id,
    check_in: new Date().toISOString()
  })
}

2.2 Chá»‘ng checkout khi chÆ°a checkin
export async function checkOut() {
  const supabase = supabaseServer()

  const { data: emp } = await supabase
    .from('employees')
    .select('id')
    .single()

  const { data: log } = await supabase
    .from('attendance_logs')
    .select('id')
    .eq('employee_id', emp.id)
    .is('check_out', null)
    .order('check_in', { ascending: false })
    .single()

  if (!log) throw new Error('No active check-in')

  await supabase
    .from('attendance_logs')
    .update({ check_out: new Date().toISOString() })
    .eq('id', log.id)
}

3ï¸âƒ£ ATTENDANCE â€“ LOGIC CHUáº¨N (CHO PAYROLL)
3.1 KhÃ´ng tÃ­nh cÃ´ng realtime

âŒ Sai: tÃ­nh cÃ´ng ngay khi checkout
âœ… ÄÃºng: raw data â†’ job tÃ­nh cÃ´ng (Phase 3)

Attendance chá»‰ cÃ³:

check_in

check_out

source

3.2 Chuáº©n bá»‹ cho ca Ä‘Ãªm
-- check_in: 2025-01-10 22:00
-- check_out: 2025-01-11 06:00


ğŸ‘‰ KhÃ´ng split record
ğŸ‘‰ Payroll xá»­ lÃ½ sau

4ï¸âƒ£ LEAVE â€“ VALIDATION NGHIá»†P Vá»¤
4.1 Chá»‘ng Ä‘Ã¨ ngÃ y nghá»‰
const { data: overlap } = await supabase
  .from('leave_requests')
  .select('id')
  .eq('employee_id', emp.id)
  .lte('from_date', form.to_date)
  .gte('to_date', form.from_date)

if (overlap.length > 0)
  throw new Error('Leave date overlap')

4.2 Cáº¥m sá»­a sau khi duyá»‡t (RLS)
create policy prevent_leave_edit_after_approved
on leave_requests
for update
using (status = 'pending');

5ï¸âƒ£ UX â€“ EMPLOYEE (THá»°C Táº¾)
5.1 Attendance page

Hiá»ƒn thá»‹:

Ca lÃ m hÃ´m nay

Giá» hiá»‡n táº¡i

Tráº¡ng thÃ¡i:

âŒ ChÆ°a check-in

âœ… ÄÃ£ check-in lÃºc 08:32

â¹ï¸ ÄÃ£ check-out lÃºc 17:45

<button disabled={checkedIn}>Check In</button>
<button disabled={!checkedIn || checkedOut}>Check Out</button>

5.2 Leave page

Calendar view

MÃ u sáº¯c:

Pending: ğŸŸ¡

Approved: ğŸŸ¢

Rejected: ğŸ”´

6ï¸âƒ£ UX â€“ MANAGER
Leave approval

Group theo nhÃ¢n viÃªn

Hiá»ƒn thá»‹:

Sá»‘ ngÃ y nghá»‰

Loáº¡i nghá»‰

Lá»‹ch sá»­ nghá»‰ gáº§n nháº¥t

7ï¸âƒ£ UX â€“ HR

Filter:

PhÃ²ng ban

Ca lÃ m

Tráº¡ng thÃ¡i

Export CSV attendance

8ï¸âƒ£ CHECKLIST PHASE 2+ (Äáº T CHUáº¨N)

âœ… 1 ngÃ y â€“ 1 attendance record
âœ… CÃ³ ca lÃ m
âœ… KhÃ´ng overlap leave
âœ… KhÃ´ng sá»­a leave Ä‘Ã£ duyá»‡t
âœ… Chuáº©n bá»‹ sáºµn cho payroll
âœ… UX khÃ´ng gÃ¢y nháº§m láº«n
